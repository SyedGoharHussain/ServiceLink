rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(uid) {
      return isAuthenticated() && request.auth.uid == uid;
    }
    
    function isValidRole(role) {
      return role == 'customer' || role == 'worker';
    }
    
    function isValidRequestStatus(status) {
      return status in ['pending', 'accepted', 'rejected', 'completed'];
    }
    
    // USERS COLLECTION
    match /users/{userId} {
      // Allow read for authenticated users (to view worker profiles)
      // Also allow read by email for password reset
      allow read: if isAuthenticated() || true;
      
      // Allow create for authenticated users or during signup
      allow create: if (isAuthenticated() 
                    && request.auth.uid == userId
                    && request.resource.data.uid == userId
                    && isValidRole(request.resource.data.role)
                    && request.resource.data.email is string
                    && request.resource.data.name is string)
                    || request.resource.data.email is string;
      
      // Allow update by owner or for password reset (update password field)
      allow update: if isOwner(userId)
                    || request.resource.data.keys().hasAny(['password', 'uid']);
      
      // Allow delete only by the owner
      allow delete: if isOwner(userId);
    }
    
    // REQUESTS COLLECTION
    match /requests/{requestId} {
      // Allow read if user is the customer or worker involved
      allow read: if isAuthenticated() 
                  && (request.auth.uid == resource.data.customerId 
                      || request.auth.uid == resource.data.workerId);
      
      // Allow create only by authenticated customers
      allow create: if isAuthenticated()
                    && request.auth.uid == request.resource.data.customerId
                    && request.resource.data.customerId is string
                    && request.resource.data.workerId is string
                    && request.resource.data.serviceType is string
                    && request.resource.data.city is string
                    && request.resource.data.price is number
                    && request.resource.data.description is string
                    && request.resource.data.status == 'pending';
      
      // Allow update if:
      // - Worker is updating status (accept/reject)
      // - Customer is updating status (complete) or adding review
      allow update: if isAuthenticated() 
                    && (
                      // Worker accepting/rejecting
                      (request.auth.uid == resource.data.workerId
                       && isValidRequestStatus(request.resource.data.status)
                       && request.resource.data.customerId == resource.data.customerId)
                      ||
                      // Customer completing or reviewing
                      (request.auth.uid == resource.data.customerId
                       && isValidRequestStatus(request.resource.data.status)
                       && request.resource.data.workerId == resource.data.workerId)
                    );
      
      // Allow delete only by customer who created it (if still pending)
      allow delete: if isAuthenticated()
                    && request.auth.uid == resource.data.customerId
                    && resource.data.status == 'pending';
    }
    
    // CHATS COLLECTION
    match /chats/{chatId} {
      // Allow read/write only if user is a participant
      allow read, write: if isAuthenticated() 
                         && request.auth.uid in resource.data.participants;
      
      // Allow create if user is one of the participants
      allow create: if isAuthenticated()
                    && request.auth.uid in request.resource.data.participants
                    && request.resource.data.participants is list
                    && request.resource.data.participants.size() == 2;
    }
    
    // MESSAGES SUBCOLLECTION (within chats)
    match /chats/{chatId}/messages/{messageId} {
      // Allow read if user is a participant of the chat
      allow read: if isAuthenticated()
                  && request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants;
      
      // Allow create if user is sender and participant
      allow create: if isAuthenticated()
                    && request.auth.uid == request.resource.data.senderId
                    && request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants;
      
      // Allow update (for marking as read)
      allow update: if isAuthenticated()
                    && request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants;
      
      // Allow delete only by sender
      allow delete: if isAuthenticated()
                    && request.auth.uid == resource.data.senderId;
    }
    
    // Deny all other access
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
